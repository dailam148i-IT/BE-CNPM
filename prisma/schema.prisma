// =============================================================================
// PRISMA SCHEMA - C·∫•u tr√∫c Database (MySQL)
// =============================================================================
//
// File n√†y ƒë·ªãnh nghƒ©a to√†n b·ªô c·∫•u tr√∫c d·ªØ li·ªáu c·ªßa ·ª©ng d·ª•ng.
//
// üèóÔ∏è DATA MODEL OVERVIEW:
//
// [USER] 1 --- n [SESSION]
//   |
//   +---- 1 --- n [ADDRESS]
//   +---- 1 --- n [ORDER]
//   +---- 1 --- n [REVIEW]
//   +---- 1 --- n [CART]
//
// [PRODUCT] 1 --- n [PRODUCT_IMAGE]
//    |
//    +---- n --- 1 [CATEGORY]
//    +---- 1 --- n [REVIEW]
//    +---- 1 --- n [ORDER_DETAIL]
//
// [ORDER] 1 --- n [ORDER_DETAIL]
//    |
//    +---- 1 --- n [TRANSACTION]
//
// =============================================================================

generator client {
  provider      = "prisma-client-js"
  engineType    = "binary"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-1.1.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================
//                          ENUMS
// ============================================================
// ƒê·ªãnh nghƒ©a c√°c t·∫≠p gi√° tr·ªã c·ªë ƒë·ªãnh (ti·∫øt ki·ªám storage & type-safe)

enum UserStatus {
  ACTIVE // Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
  INACTIVE // Ch∆∞a k√≠ch ho·∫°t (email verify)
  BANNED // B·ªã kh√≥a
}

enum CategoryType {
  PRODUCT // Danh m·ª•c s·∫£n ph·∫©m (Tr√† xanh, H·ªìng tr√†...)
  NEWS // Danh m·ª•c tin t·ª©c (Khuy·∫øn m√£i, Ki·∫øn th·ª©c...)
  PAGE // Danh m·ª•c trang tƒ©nh
}

enum ProductStatus {
  DRAFT // Nh√°p
  PUBLISHED // ƒêang b√°n
  HIDDEN // T·∫°m ·∫©n
  DISCONTINUED // Ng·ª´ng kinh doanh
}

enum OrderStatus {
  PENDING // M·ªõi ƒë·∫∑t, ch·ªù x√°c nh·∫≠n
  CONFIRMED // ƒê√£ x√°c nh·∫≠n, ƒëang ƒë√≥ng g√≥i
  SHIPPING // ƒêang giao
  COMPLETED // Giao th√†nh c√¥ng
  CANCELLED // ƒê√£ h·ªßy
}

enum PaymentStatus {
  UNPAID // Ch∆∞a thanh to√°n
  PAID // ƒê√£ thanh to√°n
  REFUNDED // ƒê√£ ho√†n ti·ªÅn
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum NewsStatus {
  DRAFT
  PUBLISHED
  HIDDEN
}

// ============================================================
//                    USER & AUTHENTICATION
// ============================================================

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(50)
  description String? @db.VarChar(255)

  users User[]

  @@map("roles")
}

model User {
  id           String     @id @default(cuid()) @db.VarChar(30)
  username     String     @unique @db.VarChar(50)
  email        String     @unique @db.VarChar(100)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  fullName     String?    @map("full_name") @db.VarChar(100)
  phone        String?    @unique @db.VarChar(15)
  dateOfBirth  DateTime?  @map("date_of_birth") @db.Date
  status       UserStatus @default(ACTIVE)
  roleId       Int        @default(1) @map("role_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  role          Role           @relation(fields: [roleId], references: [id])
  sessions      Session[]
  addresses     UserAddress[]
  orders        Order[]
  reviews       Review[]
  news          News[]
  carts         Cart[]
  notifications Notification[]

  @@index([status])
  @@index([roleId])
  @@index([phone])
  @@map("users")
}

model UserAddress {
  id            String   @id @default(cuid()) @db.VarChar(30)
  userId        String   @map("user_id") @db.VarChar(30)
  recipientName String?  @map("recipient_name") @db.VarChar(100)
  phone         String?  @db.VarChar(15)
  address       String   @db.VarChar(500)
  isDefault     Boolean  @default(false) @map("is_default")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_addresses")
}

model Session {
  id               String   @id @default(cuid()) @db.VarChar(30)
  userId           String   @map("user_id") @db.VarChar(30)
  refreshTokenHash String   @unique @map("refresh_token_hash") @db.VarChar(256)
  expiresAt        DateTime @map("expires_at")
  revoked          Boolean  @default(false)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revoked])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================================
//                         PRODUCTS
// ============================================================

model Category {
  id          String       @id @default(cuid()) @db.VarChar(30)
  name        String       @db.VarChar(255)
  slug        String       @unique @db.VarChar(255)
  description String?      @db.VarChar(500)
  parentId    String?      @map("parent_id") @db.VarChar(30)
  isActive    Boolean      @default(true) @map("is_active")
  type        CategoryType @default(PRODUCT)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]
  news     News[]

  @@index([type])
  @@index([parentId])
  @@map("categories")
}

model Product {
  id            String        @id @default(cuid()) @db.VarChar(30)
  categoryId    String?       @map("category_id") @db.VarChar(30)
  name          String        @db.VarChar(255)
  slug          String        @unique @db.VarChar(255)
  description   String?       @db.Text
  shortDesc     String?       @map("short_desc") @db.VarChar(500)
  price         Decimal       @db.Decimal(15, 2)
  stockQuantity Int           @default(0) @map("stock_quantity")
  sku           String?       @unique @db.VarChar(50)
  version       Int           @default(0)
  status        ProductStatus @default(DRAFT)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  category     Category?      @relation(fields: [categoryId], references: [id])
  images       ProductImage[]
  cartItems    CartItem[]
  orderDetails OrderDetail[]
  reviews      Review[]

  @@index([categoryId, status])
  @@index([status, createdAt])
  @@index([price])
  @@map("products")
}

model ProductImage {
  id          String  @id @default(cuid()) @db.VarChar(30)
  productId   String  @map("product_id") @db.VarChar(30)
  imageUrl    String  @map("image_url") @db.VarChar(500)
  isThumbnail Boolean @default(false) @map("is_thumbnail")
  sortOrder   Int     @default(0) @map("sort_order")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("product_images")
}

// ============================================================
//                      CART & ORDERS
// ============================================================

model Cart {
  id        String   @id @default(cuid()) @db.VarChar(30)
  userId    String?  @unique @map("user_id") @db.VarChar(30)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User?      @relation(fields: [userId], references: [id])
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid()) @db.VarChar(30)
  cartId    String   @map("cart_id") @db.VarChar(30)
  productId String   @map("product_id") @db.VarChar(30)
  quantity  Int      @default(1)
  addedAt   DateTime @default(now()) @map("added_at")

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id              String        @id @default(cuid()) @db.VarChar(30)
  userId          String?       @map("user_id") @db.VarChar(30)
  subtotal        Decimal       @db.Decimal(15, 2)
  shippingFee     Decimal       @default(0) @map("shipping_fee") @db.Decimal(15, 2)
  discountAmount  Decimal       @default(0) @map("discount_amount") @db.Decimal(15, 2)
  totalMoney      Decimal       @map("total_money") @db.Decimal(15, 2)
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID) @map("payment_status")
  shippingAddress String        @map("shipping_address") @db.VarChar(500)
  shippingPhone   String        @map("shipping_phone") @db.VarChar(20)
  note            String?       @db.VarChar(500)
  createdAt       DateTime      @default(now()) @map("created_at")

  user         User?         @relation(fields: [userId], references: [id])
  details      OrderDetail[]
  transactions Transaction[]

  @@index([userId, status])
  @@index([status, createdAt])
  @@index([paymentStatus])
  @@map("orders")
}

model OrderDetail {
  id        String  @id @default(cuid()) @db.VarChar(30)
  orderId   String  @map("order_id") @db.VarChar(30)
  productId String  @map("product_id") @db.VarChar(30)
  price     Decimal @db.Decimal(15, 2)
  quantity  Int

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_details")
}

model Transaction {
  id              String            @id @default(cuid()) @db.VarChar(30)
  orderId         String            @map("order_id") @db.VarChar(30)
  paymentMethod   String            @map("payment_method") @db.VarChar(50)
  transactionCode String?           @map("transaction_code") @db.VarChar(100)
  amount          Decimal           @db.Decimal(15, 2)
  status          TransactionStatus @default(PENDING)
  paidAt          DateTime          @default(now()) @map("paid_at")
  description     String?           @db.VarChar(500)

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
  @@map("transactions")
}

// ============================================================
//                         CONTENT
// ============================================================

model News {
  id          String     @id @default(cuid()) @db.VarChar(30)
  categoryId  String?    @map("category_id") @db.VarChar(30)
  authorId    String     @map("author_id") @db.VarChar(30)
  title       String     @db.VarChar(255)
  slug        String     @unique @db.VarChar(255)
  description String?    @db.VarChar(1000)
  content     String?    @db.Text
  imageUrl    String?    @map("image_url") @db.VarChar(500)
  publishedAt DateTime   @default(now()) @map("published_at")
  status      NewsStatus @default(PUBLISHED)

  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  author   User      @relation(fields: [authorId], references: [id])

  @@index([status, publishedAt])
  @@index([categoryId])
  @@index([authorId])
  @@map("news")
}

model Review {
  id          String   @id @default(cuid()) @db.VarChar(30)
  userId      String   @map("user_id") @db.VarChar(30)
  productId   String   @map("product_id") @db.VarChar(30)
  rating      Int
  commentText String?  @map("comment_text") @db.VarChar(1000)
  createdAt   DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([productId, rating])
  @@map("reviews")
}

// ============================================================
//                      NOTIFICATIONS
// ============================================================

enum NotificationType {
  ORDER_NEW
  ORDER_STATUS
  ORDER_CANCELLED
  STOCK_LOW
  STOCK_OUT
  REVIEW_NEW
  USER_REGISTERED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  PROMOTION
  SYSTEM
}

model Notification {
  id        String           @id @default(cuid()) @db.VarChar(30)
  userId    String?          @map("user_id") @db.VarChar(30) // null = admin notification
  type      NotificationType
  title     String           @db.VarChar(255)
  message   String?          @db.VarChar(1000)
  data      Json? // JSON metadata
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")
  readAt    DateTime?        @map("read_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}
